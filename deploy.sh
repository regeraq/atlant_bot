#!/bin/bash

# ะกะบัะธะฟั ะดะปั ะดะตะฟะปะพั ะฑะพัะฐ ะฝะฐ ัะตัะฒะตั
# ะัะฟะพะปัะทะพะฒะฐะฝะธะต: ./deploy.sh

set -e  # ะััะฐะฝะพะฒะบะฐ ะฟัะธ ะพัะธะฑะบะต

echo "๐ ะะฐัะธะฝะฐะตะผ ะดะตะฟะปะพะน ะฑะพัะฐ..."

# ะัะพะฒะตััะตะผ ะฝะฐะปะธัะธะต .env ัะฐะนะปะฐ
if [ ! -f .env ]; then
    echo "โ ะคะฐะนะป .env ะฝะต ะฝะฐะนะดะตะฝ!"
    echo "๐ ะกะพะทะดะฐะนัะต ัะฐะนะป .env ะฝะฐ ะพัะฝะพะฒะต .env.example:"
    echo "   cp .env.example .env"
    echo "   nano .env  # ะธะปะธ ะธัะฟะพะปัะทัะนัะต ะฒะฐั ัะตะดะฐะบัะพั"
    exit 1
fi

# ะัะพะฒะตััะตะผ ะฝะฐะปะธัะธะต Docker
if ! command -v docker &> /dev/null; then
    echo "โ Docker ะฝะต ัััะฐะฝะพะฒะปะตะฝ!"
    echo "๐ฆ ะฃััะฐะฝะพะฒะธัะต Docker: https://docs.docker.com/get-docker/"
    exit 1
fi

# ะัะพะฒะตััะตะผ ะฝะฐะปะธัะธะต docker-compose
if ! command -v docker-compose &> /dev/null; then
    echo "โ docker-compose ะฝะต ัััะฐะฝะพะฒะปะตะฝ!"
    echo "๐ฆ ะฃััะฐะฝะพะฒะธัะต docker-compose: https://docs.docker.com/compose/install/"
    exit 1
fi

# ะกะพะทะดะฐะตะผ ะฝะตะพะฑัะพะดะธะผัะต ะดะธัะตะบัะพัะธะธ
echo "๐ ะกะพะทะดะฐะตะผ ะดะธัะตะบัะพัะธะธ..."
mkdir -p data logs

# ะััะฐะฝะฐะฒะปะธะฒะฐะตะผ ััะฐััะน ะบะพะฝัะตะนะฝะตั (ะตัะปะธ ะตััั)
echo "๐ ะััะฐะฝะฐะฒะปะธะฒะฐะตะผ ััะฐััะน ะบะพะฝัะตะนะฝะตั..."
docker-compose down || true

# ะกะพะฑะธัะฐะตะผ ะฝะพะฒัะน ะพะฑัะฐะท
echo "๐จ ะกะพะฑะธัะฐะตะผ Docker ะพะฑัะฐะท..."
docker-compose build --no-cache

# ะะฐะฟััะบะฐะตะผ ะบะพะฝัะตะนะฝะตั
echo "โถ๏ธ  ะะฐะฟััะบะฐะตะผ ะฑะพัะฐ..."
docker-compose up -d

# ะะพะบะฐะทัะฒะฐะตะผ ะปะพะณะธ
echo "๐ ะะพะณะธ ะฑะพัะฐ (Ctrl+C ะดะปั ะฒััะพะดะฐ):"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
docker-compose logs -f

